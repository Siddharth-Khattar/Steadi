---
phase: 03-overlay-and-auto-scroll
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/overlay/App.tsx
  - src/overlay/hooks/useOverlayControls.ts
autonomous: false

must_haves:
  truths:
    - "User can play/pause scrolling with a keyboard shortcut (space locally, Cmd+Shift+Space globally)"
    - "User can cycle through speed presets (slow/medium/fast) with a brief on-screen indicator"
    - "User can manually scroll up/down using keyboard shortcuts"
    - "User can rewind one sentence at a time with a keyboard shortcut"
    - "Hovering the mouse over the overlay content instantly freezes scrolling; moving away resumes"
    - "User can adjust font size and opacity via keyboard shortcuts, and these persist across restarts"
  artifacts:
    - path: "src/overlay/hooks/useOverlayControls.ts"
      provides: "Local keyboard event handlers and hover-to-pause logic for overlay window"
      exports: ["useOverlayControls"]
      min_lines: 40
    - path: "src/overlay/App.tsx"
      provides: "Fully integrated teleprompter with all controls, visual polish, and window management"
      min_lines: 60
  key_links:
    - from: "src/overlay/hooks/useOverlayControls.ts"
      to: "src/stores/teleprompterStore.ts"
      via: "Keyboard handlers call store actions"
      pattern: "useTeleprompterStore"
    - from: "src/overlay/App.tsx"
      to: "src/overlay/hooks/useOverlayControls.ts"
      via: "Hook called in App, receives container ref for hover detection"
      pattern: "useOverlayControls"
---

<objective>
Add keyboard controls (local and global), hover-to-pause, sentence-level rewind, font size/opacity adjustment, a speed indicator toast, and perform end-to-end integration of all overlay features from Plans 01-03.

Purpose: This makes the teleprompter fully controllable during a presentation. Without controls, the user cannot pause, adjust speed, or navigate the script. This plan also integrates all pieces from prior plans into a cohesive experience and includes a human verification checkpoint.

Output: useOverlayControls.ts hook, fully integrated overlay App.tsx, end-to-end working teleprompter.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-overlay-and-auto-scroll/03-CONTEXT.md
@.planning/phases/03-overlay-and-auto-scroll/03-RESEARCH.md
@.planning/phases/03-overlay-and-auto-scroll/03-01-SUMMARY.md
@.planning/phases/03-overlay-and-auto-scroll/03-02-SUMMARY.md
@.planning/phases/03-overlay-and-auto-scroll/03-03-SUMMARY.md
@src/overlay/App.tsx
@src/overlay/hooks/useAutoScroll.ts
@src/overlay/hooks/useOverlayEvents.ts
@src/overlay/hooks/useOverlayGeometry.ts
@src/overlay/components/TeleprompterView.tsx
@src/overlay/components/WindowControls.tsx
@src/stores/teleprompterStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create overlay controls hook and integrate all features in App.tsx</name>
  <files>src/overlay/hooks/useOverlayControls.ts, src/overlay/App.tsx</files>
  <action>
**useOverlayControls.ts:**

Create a hook for local keyboard controls and hover-to-pause within the overlay window.

Parameters: { contentRef: React.RefObject<HTMLDivElement | null>, onRewind: () => void, onScrollUp: () => void, onScrollDown: () => void }

**Local keyboard bindings** (document-level keydown listener, active when overlay window is focused):
- Space: toggle play/pause (call store.togglePlay)
- Escape: stop teleprompter entirely (call store.resetTeleprompter, then clear scriptContent)
- BracketLeft `[`: decrease font size (store.decreaseFontSize)
- BracketRight `]`: increase font size (store.increaseFontSize)
- Minus `-`: decrease opacity (store.decreaseOpacity)
- Equal `=`: increase opacity (store.increaseOpacity)

Note: play/pause, speed cycle, rewind, scroll up/down are ALSO handled by global shortcuts (registered in Rust, arrive via events through useOverlayEvents). The local bindings provide the same functionality when the overlay window has focus, using standard keys without modifiers. Both paths end up calling the same store actions.

**Hover-to-pause logic:**
- Attach mouseenter/mouseleave listeners to the contentRef element (the scroll container, NOT the window edges -- this avoids triggering pause when approaching resize handles)
- On mouseenter: if isPlaying, set a "paused by hover" flag (useRef), call store.setPlaying(false)
- On mouseleave: if "paused by hover" flag is set, call store.setPlaying(true), clear flag
- The flag prevents hover-unpause from resuming if the user manually paused
- No visual indicator (per CONTEXT.md: "no visual indicator, scroll simply freezes")

**Speed indicator:**
When the speed preset changes (via cycleSpeed), show a brief on-screen indicator:
- Maintain a local state: speedIndicator: string | null (e.g., "Medium")
- Subscribe to speedPreset changes: use a useEffect that watches store.speedPreset
- When speedPreset changes, set speedIndicator to the preset name (capitalized), then clear after 1.5 seconds via setTimeout
- Return speedIndicator from the hook so App.tsx can render it

**Sentence-level rewind:**
For the onRewind callback passed to the hook (and to useOverlayEvents), implement sentence detection:
- Get the current scroll position from the scroll engine
- Use Intl.Segmenter with granularity 'sentence' to split the script content into sentences
- Estimate which sentence corresponds to the current scroll position by calculating character-to-pixel ratio: (scrollPosition / maxScroll) * totalCharacters gives approximate character offset
- Find the start of the previous sentence boundary using the segmenter
- Convert that character offset back to a scroll position and call setScrollPosition
- This is approximate but good enough for teleprompter rewind (user presses rewind multiple times to go back further)

**Full integration in overlay/App.tsx:**

By this point, Plans 02 and 03 have already modified App.tsx. This task does the final integration pass:

1. Ensure all hooks are called: useOverlayEvents, useAutoScroll, useOverlayControls, useOverlayGeometry
2. Ensure all components are rendered: TeleprompterView, Countdown, ProgressBar, WindowControls
3. Add the speed indicator rendering:
```typescript
{speedIndicator && (
  <div className="absolute top-4 right-4 bg-white/10 text-white/80 text-sm px-3 py-1 rounded-full z-40 pointer-events-none">
    {speedIndicator}
  </div>
)}
```

4. Wire the rewind callback properly:
- Create a rewindToSentence function that uses Intl.Segmenter (as described above)
- Pass it as onRewind to both useOverlayEvents and useOverlayControls

5. Wire scroll-up and scroll-down callbacks:
- scrollUp: `scrollEngine.setScrollPosition(Math.max(0, scrollEngine.getScrollPosition() - 80))`
- scrollDown: `scrollEngine.setScrollPosition(scrollEngine.getScrollPosition() + 80)`
- Pass to both useOverlayEvents and useOverlayControls

6. Ensure the Countdown onComplete callback triggers via the store's decrementCountdown mechanism (the countdown calls decrementCountdown every second, and when it reaches 0, the store sets isPlaying to true and showCountdown to false)

7. Make sure the overlay opacity is applied to the outermost div via inline style

8. Verify the reading-line highlight, top-edge fade, and progress bar are all present and properly layered (z-index order: content at base, reading highlight above, resize handles on top, countdown above everything)

Start useOverlayControls.ts with ABOUTME comments.
  </action>
  <verify>
Run `npx tsc -b --noEmit` -- no type errors.
Run `npm run build` -- build succeeds.
Run `cargo tauri build --debug` or `cargo tauri dev` to verify the app launches with the teleprompter functional.
  </verify>
  <done>
All overlay controls work: local keyboard (space, escape, brackets, minus/equal), hover-to-pause on content area, sentence-level rewind, speed indicator toast. App.tsx integrates all hooks and components from Plans 01-03.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete teleprompter overlay with:
- Start from editor (sends active script, minimizes editor)
- 3-2-1 countdown with dimmed script underneath
- Smooth auto-scrolling at 3 speed presets
- Markdown rendering (bold, headers, emphasis, lists)
- Top-edge fade effect, progress bar, reading-line highlight
- Keyboard controls: Space (play/pause), speed cycle, rewind, font size, opacity
- Global shortcuts: Cmd+Shift+Space (play/pause), Cmd+Shift+D (speed), Cmd+Shift+A (rewind)
- Draggable overlay (top grab strip)
- Resizable overlay (edge/corner drag)
- Hover-to-pause (mouse over content freezes scroll)
- Persistent overlay position, size, font size, opacity, speed preset
  </what-built>
  <how-to-verify>
1. Run `cargo tauri dev` from the project root
2. Create a script in the editor with markdown content: headers, bold text, bullet lists, multiple paragraphs (enough to need scrolling)
3. Click "Start" in the top bar
4. Verify: editor minimizes, overlay shows script with 3-2-1 countdown, then scrolling begins
5. Test speed: press Cmd+Shift+D multiple times -- speed indicator shows "Slow", "Medium", "Fast"
6. Test play/pause: press Space (when overlay focused) or Cmd+Shift+Space (from any app)
7. Test hover-to-pause: move mouse over overlay text -- scrolling freezes; move away -- scrolling resumes
8. Test rewind: press Cmd+Shift+A -- scroll jumps back approximately one sentence
9. Test resize: drag overlay edges/corners to resize
10. Test drag: drag the top strip of the overlay to reposition
11. Test font size: press [ and ] -- text gets smaller/larger
12. Test opacity: press - and = -- overlay gets more/less transparent
13. Quit and relaunch: verify overlay position, size, font size, opacity, and speed preset are restored
14. Verify progress bar fills as script scrolls to end
15. Verify top-edge fade: text at top of overlay fades out
16. Verify markdown renders correctly: headers are larger, bold is bright, lists have bullets
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc -b --noEmit` passes
2. `npm run build` succeeds
3. All keyboard shortcuts work (local and global)
4. Hover-to-pause works on content area but NOT on resize edges
5. Speed indicator appears briefly when cycling presets
6. Rewind scrolls back approximately one sentence
7. Font size and opacity adjustable via keyboard, persisted
8. Complete end-to-end flow: editor -> start -> countdown -> scroll -> controls -> persist
</verification>

<success_criteria>
- All Phase 3 requirements satisfied: OVRL-02 through OVRL-08, SCRL-04, SCRL-05, CTRL-01 through CTRL-05, DSGN-04
- Teleprompter is fully controllable via keyboard during presentations
- All overlay preferences persist across restarts
- Human verification confirms the complete experience works
</success_criteria>

<output>
After completion, create `.planning/phases/03-overlay-and-auto-scroll/03-04-SUMMARY.md`
</output>
