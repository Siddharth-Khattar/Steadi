---
phase: 01-platform-validation-spike
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - tsconfig.node.json
  - vite.config.ts
  - src/main/index.html
  - src/main/main.tsx
  - src/overlay/index.html
  - src/overlay/main.tsx
  - src/styles/globals.css
  - src-tauri/Cargo.toml
  - src-tauri/tauri.conf.json
  - src-tauri/build.rs
  - src-tauri/src/main.rs
  - src-tauri/src/lib.rs
  - src-tauri/src/overlay.rs
  - src-tauri/src/commands.rs
  - src-tauri/capabilities/main-window.json
  - src-tauri/capabilities/overlay-window.json
autonomous: true

must_haves:
  truths:
    - "Running `cargo tauri dev` opens a main window and a separate overlay window"
    - "The overlay window is transparent, always-on-top, borderless, and positioned at top-center of screen"
    - "The overlay window has native vibrancy (frosted glass effect from OS, not CSS)"
    - "Pressing Cmd+Shift+S (macOS) or Ctrl+Shift+S (Windows) toggles overlay visibility"
    - "The overlay is marked as content-protected (screen capture exclusion enabled)"
  artifacts:
    - path: "src-tauri/src/overlay.rs"
      provides: "Overlay window creation with content_protected, vibrancy, positioning"
      exports: ["create_overlay", "toggle_overlay"]
    - path: "src-tauri/src/lib.rs"
      provides: "Tauri app builder with global shortcut plugin and overlay setup"
    - path: "src-tauri/tauri.conf.json"
      provides: "Main window config with macOSPrivateApi enabled"
      contains: "macOSPrivateApi"
    - path: "vite.config.ts"
      provides: "Multi-page build with main + overlay entry points"
  key_links:
    - from: "src-tauri/src/lib.rs"
      to: "src-tauri/src/overlay.rs"
      via: "setup closure calls create_overlay"
      pattern: "overlay::create_overlay"
    - from: "src-tauri/src/lib.rs"
      to: "tauri-plugin-global-shortcut"
      via: "plugin registration + shortcut handler"
      pattern: "global_shortcut"
    - from: "vite.config.ts"
      to: "src/main/index.html, src/overlay/index.html"
      via: "rollupOptions.input multi-page entries"
      pattern: "rollupOptions"
---

<objective>
Scaffold the Tauri 2 project and implement the Rust overlay backend with screen capture exclusion, native vibrancy, and global shortcut toggle.

Purpose: Establish the complete project structure and make the invisible overlay window functional from the Rust side. This is the foundation that all subsequent plans build on.
Output: A runnable Tauri app with a main window, an invisible glassmorphic overlay window at top-center, and a global keyboard shortcut to toggle the overlay.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-platform-validation-spike/01-CONTEXT.md
@.planning/phases/01-platform-validation-spike/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Tauri 2 project with multi-page Vite configuration</name>
  <files>
    package.json
    tsconfig.json
    tsconfig.node.json
    vite.config.ts
    src/main/index.html
    src/main/main.tsx
    src/overlay/index.html
    src/overlay/main.tsx
    src/styles/globals.css
    src-tauri/Cargo.toml
    src-tauri/tauri.conf.json
    src-tauri/build.rs
    src-tauri/src/main.rs
    src-tauri/capabilities/main-window.json
    src-tauri/capabilities/overlay-window.json
  </files>
  <action>
    Create the Tauri 2 project. Use `npm create tauri-app@latest` with the react-ts template as a starting point, then restructure to the multi-window architecture. If the scaffolder produces a flat `src/` layout, reorganize into `src/main/` and `src/overlay/` subdirectories.

    **Project structure to achieve:**
    ```
    steadi/
    ├── src/
    │   ├── main/
    │   │   ├── index.html       # Main window HTML entry
    │   │   └── main.tsx         # React mount (minimal -- just renders a placeholder div)
    │   ├── overlay/
    │   │   ├── index.html       # Overlay HTML entry (transparent body inline style)
    │   │   └── main.tsx         # React mount (minimal -- just renders a placeholder div)
    │   └── styles/
    │       └── globals.css      # Tailwind import + transparent body styles
    ├── src-tauri/
    │   ├── Cargo.toml
    │   ├── tauri.conf.json
    │   ├── build.rs
    │   ├── capabilities/
    │   │   ├── main-window.json
    │   │   └── overlay-window.json
    │   └── src/
    │       └── main.rs
    ├── package.json
    ├── vite.config.ts
    └── tsconfig.json
    ```

    **vite.config.ts:** Configure multi-page build with `rollupOptions.input` pointing to both `src/main/index.html` and `src/overlay/index.html`. Include `@vitejs/plugin-react` and `@tailwindcss/vite` plugins.

    **tauri.conf.json:** Set `app.macOSPrivateApi: true`. Configure only the main window statically (the overlay is created dynamically from Rust). Set `build.frontendDist: "../dist"`. Set `app.security.csp` to `"default-src 'self'; style-src 'self' 'unsafe-inline'"`. Use identifier `com.steadi.app`.

    **Cargo.toml:** Add dependencies: `tauri = { version = "2", features = ["macos-private-api"] }`, `tauri-plugin-global-shortcut = "2"`, `serde = { version = "1", features = ["derive"] }`, `serde_json = "1"`.

    **package.json:** Install frontend dependencies: `react`, `react-dom`, `tailwindcss`, `@tailwindcss/vite`. Dev dependencies: `@tauri-apps/cli`, `typescript`, `@types/react`, `@types/react-dom`, `@vitejs/plugin-react`, `vite`. Add `@tauri-apps/plugin-global-shortcut` as a dependency for frontend shortcut APIs if needed later.

    **HTML entry points:** Both `src/main/index.html` and `src/overlay/index.html` should have a `<div id="root"></div>` and `<script type="module" src="./main.tsx"></script>`. The overlay HTML must have an inline style `html, body { background: transparent; margin: 0; overflow: hidden; }` in a `<style>` tag in the `<head>`.

    **globals.css:** `@import "tailwindcss";` plus `html, body { background: transparent; margin: 0; padding: 0; overflow: hidden; user-select: none; -webkit-user-select: none; }`.

    **main.tsx files:** Minimal React mount -- `createRoot(document.getElementById('root')!).render(<App />)` where `App` is a placeholder component (e.g., `<div>Steadi</div>` for main, `<div>Overlay</div>` for overlay). Import globals.css.

    **Capabilities:** Create `src-tauri/capabilities/main-window.json` with permissions for `core:default`, `global-shortcut:allow-register`, `global-shortcut:allow-unregister`, `global-shortcut:allow-is-registered`. Create `src-tauri/capabilities/overlay-window.json` with only `core:default`.

    Use Context7 to verify the latest Tauri v2 API and Vite multi-page configuration if needed.
  </action>
  <verify>
    Run `npm install` successfully. Run `cargo check` in `src-tauri/` with no errors. Verify `vite.config.ts` references both entry points. Verify `tauri.conf.json` has `macOSPrivateApi: true`.
  </verify>
  <done>
    Project scaffolded with correct directory structure. `npm install` and `cargo check` pass. Multi-page Vite config in place. Tauri config has macOSPrivateApi enabled. Both HTML entry points exist with correct script references.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Rust overlay backend with screen capture exclusion and global shortcut</name>
  <files>
    src-tauri/src/lib.rs
    src-tauri/src/overlay.rs
    src-tauri/src/commands.rs
  </files>
  <action>
    Create the Rust backend that manages the overlay window lifecycle, screen capture exclusion, and global shortcut.

    **src-tauri/src/overlay.rs:**
    - Start with ABOUTME comment: "Creates and manages the invisible glassmorphic overlay window with platform-specific screen capture exclusion and vibrancy effects."
    - `pub fn create_overlay(app: &AppHandle) -> tauri::Result<WebviewWindow>`: Creates the overlay window using `WebviewWindowBuilder` with these exact settings:
      - `WebviewUrl::App("overlay/index.html".into())`
      - `.title("Steadi Overlay")`
      - `.transparent(true)` -- critical for see-through overlay
      - `.decorations(false)` -- borderless
      - `.always_on_top(true)` -- floats above all windows
      - `.shadow(false)` -- no window shadow (vibrancy provides edge definition)
      - `.skip_taskbar(true)` -- does not show in taskbar/dock
      - `.resizable(false)` -- fixed size for Phase 1
      - `.visible(true)` -- show immediately on creation
      - `.content_protected(true)` -- THE critical invisibility flag
      - `.inner_size(overlay_width, overlay_height)` -- calculated from monitor
      - `.position(x, y)` -- centered horizontally, at top of screen
      - `.effects(effects)` -- native vibrancy
    - Positioning: Get primary monitor via `app.primary_monitor()`, calculate overlay width as ~55% of screen width (logical pixels, divide physical by scale factor), height ~160px, x-centered, y = 0 (top of screen).
    - Effects: Use `EffectsBuilder` with `.effect(Effect::HudWindow)` (macOS dark HUD material) AND `.effect(Effect::Acrylic)` (Windows acrylic -- Tauri applies first applicable per-platform). Set `.state(EffectState::Active)` (stay active when unfocused), `.radius(10.0)` (rounded corners), `.color(Color(0, 0, 0, 200))` (dark smoke tint).
    - `pub fn toggle_overlay(app: &AppHandle) -> tauri::Result<bool>`: If overlay window exists (check `app.webview_windows().get("overlay")`), toggle visibility. If it does not exist, create it. Return new visibility state.

    **src-tauri/src/commands.rs:**
    - Start with ABOUTME comment: "Tauri IPC command handlers for overlay window management."
    - `#[tauri::command] pub fn toggle_overlay(app: AppHandle) -> Result<bool, String>`: Wraps `overlay::toggle_overlay`, maps errors to strings.
    - `#[tauri::command] pub fn create_overlay(app: AppHandle) -> Result<(), String>`: Wraps `overlay::create_overlay`, maps errors to strings.

    **src-tauri/src/lib.rs:**
    - Start with ABOUTME comment: "Tauri application entry point. Initializes plugins, registers global shortcuts, and sets up command handlers."
    - Declare `mod commands; mod overlay;`
    - In `run()` function:
      1. Register `tauri_plugin_global_shortcut` plugin with a handler that calls `overlay::toggle_overlay(app)` on `ShortcutState::Pressed`.
      2. Register invoke handlers: `commands::toggle_overlay`, `commands::create_overlay`.
      3. In `.setup()` closure: register `Shortcut::new(Some(Modifiers::SUPER | Modifiers::SHIFT), Code::KeyS)` via `app.global_shortcut().register()`. Then call `overlay::create_overlay(app.handle())` to create the overlay on startup.
    - Use `#[cfg_attr(mobile, tauri::mobile_entry_point)]` on the run function.

    **Import paths to use:**
    - `tauri::webview::{WebviewUrl, WebviewWindowBuilder}`
    - `tauri::window::{Color, Effect, EffectState, EffectsBuilder}`
    - `tauri::{AppHandle, Manager, WebviewWindow}`
    - `tauri_plugin_global_shortcut::{Code, GlobalShortcutExt, Modifiers, Shortcut, ShortcutState}`

    Use Context7 to verify exact Tauri v2 API signatures if any import paths have changed.
  </action>
  <verify>
    Run `cargo check` in `src-tauri/` with no errors. Run `cargo tauri dev` -- main window opens AND a separate overlay window appears at top-center of screen with frosted glass effect and no title bar. Press Cmd+Shift+S -- overlay toggles visibility. Press again -- overlay reappears.
  </verify>
  <done>
    Overlay window is created on app startup via Rust. It is transparent, always-on-top, borderless, content-protected, with native vibrancy effects. Cmd+Shift+S toggles its visibility. `cargo check` has no errors or warnings.
  </done>
</task>

</tasks>

<verification>
1. `npm install` completes without errors
2. `cargo check` in `src-tauri/` passes with no errors
3. `cargo tauri dev` opens two windows: a main window and an overlay window
4. Overlay window is at top-center of screen, borderless, transparent, with frosted glass appearance
5. Overlay window stays on top of other windows
6. Cmd+Shift+S (macOS) toggles overlay visibility on/off
7. No compilation warnings in Rust code
</verification>

<success_criteria>
- Tauri 2 project structure matches the multi-window architecture from research
- Overlay window renders with native vibrancy (not CSS blur)
- content_protected is set to true on the overlay window
- Global shortcut toggles overlay visibility
- Both main and overlay HTML entry points build correctly via Vite multi-page setup
</success_criteria>

<output>
After completion, create `.planning/phases/01-platform-validation-spike/01-01-SUMMARY.md`
</output>
