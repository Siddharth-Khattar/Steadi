---
phase: 01-platform-validation-spike
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - .planning/phases/01-platform-validation-spike/COMPATIBILITY-MATRIX.md
autonomous: false

must_haves:
  truths:
    - "Production build (.app bundle on macOS) maintains overlay transparency and vibrancy"
    - "Production build maintains content protection (overlay excluded from screen capture)"
    - "The application makes zero network calls during operation"
    - "A compatibility matrix documents overlay visibility across screen sharing apps and OS versions tested"
  artifacts:
    - path: "src-tauri/target/release/bundle/"
      provides: "Production build artifacts (DMG on macOS, MSI/NSIS on Windows)"
    - path: ".planning/phases/01-platform-validation-spike/COMPATIBILITY-MATRIX.md"
      provides: "Screen sharing test results across apps and platforms"
  key_links:
    - from: "src-tauri/tauri.conf.json"
      to: "src-tauri/target/release/bundle/"
      via: "cargo tauri build reads config to produce bundle"
      pattern: "macOSPrivateApi"
---

<objective>
Build for production and verify overlay invisibility across screen sharing applications.

Purpose: This is the entire point of Phase 1 -- prove that the invisible overlay actually works in production builds against real screen sharing tools. A dev-mode-only demo is worthless. This plan validates the core value proposition.
Output: A production build with verified invisibility, a compatibility matrix documenting results, and confidence to proceed to Phase 2.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-platform-validation-spike/01-CONTEXT.md
@.planning/phases/01-platform-validation-spike/01-RESEARCH.md
@.planning/phases/01-platform-validation-spike/01-01-SUMMARY.md
@.planning/phases/01-platform-validation-spike/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create production build and verify transparency persists</name>
  <files>(no source changes -- build artifacts only)</files>
  <action>
    Build the production app bundle and verify that transparency, vibrancy, and content protection work correctly outside of dev mode. This is critical because Tauri issue #13415 documents transparency loss after production bundling on macOS.

    **Steps:**

    1. Run `cargo tauri build` from the project root. This produces:
       - macOS: `.app` bundle in `src-tauri/target/release/bundle/macos/` and `.dmg` in `src-tauri/target/release/bundle/dmg/`
       - Windows: `.msi` in `src-tauri/target/release/bundle/msi/` or `.exe` in `src-tauri/target/release/bundle/nsis/`

    2. Launch the production build (NOT from `cargo tauri dev`):
       - macOS: `open src-tauri/target/release/bundle/macos/Steadi.app`
       - Windows: Run the installer, then launch the installed app

    3. Verify these behaviors in the production build:
       - Overlay window appears at top-center with frosted glass effect
       - Overlay background is transparent (desktop visible through the glass)
       - Native vibrancy effect is active (real OS blur, not just a dark rectangle)
       - Cmd+Shift+S toggles overlay visibility
       - Main window shows correctly with all UI elements
       - No white/black flash on the overlay when switching focus between windows

    4. Verify network isolation (PLAT-09):
       - macOS: Run `nettop -p $(pgrep Steadi) -J bytes_in,bytes_out` while using the app for 30 seconds. Verify zero bytes transferred.
       - Alternative: Use Activity Monitor > Network tab, filter for Steadi process
       - Windows: Use Resource Monitor > Network tab, filter for Steadi.exe

    5. If transparency breaks in production build but works in dev:
       - Verify `macOSPrivateApi: true` is in tauri.conf.json
       - Verify `macos-private-api` feature is in Cargo.toml
       - Verify HTML body has `background: transparent` inline style
       - If still broken, investigate programmatic NSWindow background color override via raw Objective-C bridge as documented in research

    If the build fails, fix the build errors. Common issues:
    - Missing icons: Create placeholder icons or use Tauri's default icon set. Run `cargo tauri icon` if needed.
    - Code signing on macOS: For dev testing, ad-hoc signing is fine. Don't worry about notarization for the spike.
  </action>
  <verify>
    Production build launches successfully. Overlay has transparency and vibrancy matching dev mode. No network calls detected. Cmd+Shift+S works in production build.
  </verify>
  <done>
    Production build works identically to dev mode: overlay is transparent, vibrancy is active, toggle shortcut works, zero network calls. Build artifacts exist in `src-tauri/target/release/bundle/`.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Screen share invisibility testing</name>
  <what-built>
    A production-built Steadi app with an invisible overlay window. The overlay uses `content_protected(true)` which sets `NSWindow.sharingType = .none` on macOS and `SetWindowDisplayAffinity(WDA_EXCLUDEFROMCAPTURE)` on Windows. The overlay should be visible on your desktop but invisible to screen sharing applications.
  </what-built>
  <how-to-verify>
    Test the overlay against each screen sharing tool available on your system. For each test:

    1. Launch the production build of Steadi (from the .app bundle, NOT `cargo tauri dev`)
    2. Verify the overlay is visible on your desktop with the frosted glass effect
    3. Open the screen sharing application
    4. Start sharing your screen
    5. Check the shared output -- does the overlay appear?
    6. If the app supports "Share Window" mode (separate from "Share Screen"), test that mode too

    **Test matrix to fill in:**

    | App | Share Mode | OS Version | Overlay Visible? |
    |-----|-----------|------------|-----------------|
    | Zoom | Share Screen | ? | ? |
    | Zoom | Share Window | ? | ? |
    | Teams | Share Screen | ? | ? |
    | Teams | Share Window | ? | ? |
    | Meet | Share Screen | ? | ? |
    | OBS | Display Capture | ? | ? |
    | OBS | Window Capture | ? | ? |

    Test whatever apps you have available. Skip apps you don't have installed -- we can test those later.

    **Also verify these visual qualities:**
    - Does the frosted glass look like macOS Control Center? (Native, clean, system-level)
    - Is the text legible and comfortable to read?
    - Is the overlay positioned correctly at top-center?
    - Does it feel like a real product, not a tech demo?

    **Report your findings** -- both the compatibility matrix results and any visual feedback. If the overlay IS visible in screen shares, that is critical information we need for the project direction.
  </how-to-verify>
  <resume-signal>
    Share the test results. For each app tested, report: app name, share mode, OS version, and whether the overlay was visible (Hidden/Visible). Also share any visual feedback or issues noticed.

    After you share results, Claude will create the COMPATIBILITY-MATRIX.md documenting the findings and complete the phase summary.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Document compatibility matrix from test results</name>
  <files>
    .planning/phases/01-platform-validation-spike/COMPATIBILITY-MATRIX.md
  </files>
  <action>
    After receiving the user's screen share test results, create a compatibility matrix document.

    **File: `.planning/phases/01-platform-validation-spike/COMPATIBILITY-MATRIX.md`**

    Document:
    1. Test date and tester's system info (macOS version, hardware)
    2. The test results in a matrix table (App x Share Mode x OS = Hidden/Visible)
    3. Summary of findings:
       - Which apps/modes successfully hide the overlay
       - Which apps/modes show the overlay (if any)
       - Any differences between "Share Screen" and "Share Window" modes
    4. Assessment:
       - Overall confidence in the invisibility approach
       - Any workarounds needed
       - Implications for the project (proceed as planned, need alternative approach, or partial compatibility acceptable)
    5. Visual quality notes from user feedback

    This document becomes the project's official compatibility statement and informs whether Phase 2 should proceed as planned.
  </action>
  <verify>
    COMPATIBILITY-MATRIX.md exists with populated test results. All tested apps are documented. Summary and assessment sections are filled in based on actual results.
  </verify>
  <done>
    Compatibility matrix documents all screen share test results with clear assessment of the invisibility approach's viability. The phase can be marked complete based on these results.
  </done>
</task>

</tasks>

<verification>
1. `cargo tauri build` produces a production bundle without errors
2. Production build maintains overlay transparency and vibrancy
3. Production build maintains content protection
4. Zero network calls during application operation
5. Screen share test results documented in COMPATIBILITY-MATRIX.md
6. Assessment of invisibility viability is clear and actionable
</verification>

<success_criteria>
- Production build works: transparency, vibrancy, toggle shortcut all functional
- Screen sharing tested against at least 2 apps (whatever user has available)
- Compatibility matrix documents empirical results
- Clear go/no-go assessment for proceeding to Phase 2
- PLAT-09 verified: zero network calls
</success_criteria>

<output>
After completion, create `.planning/phases/01-platform-validation-spike/01-03-SUMMARY.md`
</output>
