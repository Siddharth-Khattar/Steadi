---
phase: 02-script-editor
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/components/preview/MarkdownPreview.tsx
  - src/components/toolbar/TopBar.tsx
  - src/main/App.tsx
  - src/styles/globals.css
  - src-tauri/tauri.conf.json
autonomous: false

must_haves:
  truths:
    - "User sees a three-panel layout: collapsible sidebar, editor, toggleable preview"
    - "User can toggle the sidebar on and off"
    - "User can toggle the markdown preview panel on and off"
    - "Preview shows rendered markdown that updates as user types"
    - "Top-right area has Start Teleprompter and Settings buttons"
    - "Panels can be resized by dragging dividers"
    - "Main window is sized appropriately for an editor app"
    - "Closing and reopening the app shows the same scripts and folders"
  artifacts:
    - path: "src/components/preview/MarkdownPreview.tsx"
      provides: "Rendered markdown preview panel"
      exports: ["MarkdownPreview"]
    - path: "src/components/toolbar/TopBar.tsx"
      provides: "Top toolbar with sidebar toggle, preview toggle, and teleprompter controls"
      exports: ["TopBar"]
    - path: "src/main/App.tsx"
      provides: "Three-panel layout with resizable panels"
      contains: "PanelGroup"
  key_links:
    - from: "src/main/App.tsx"
      to: "react-resizable-panels"
      via: "PanelGroup, Panel, PanelResizeHandle"
      pattern: "PanelGroup"
    - from: "src/main/App.tsx"
      to: "src/components/sidebar/Sidebar.tsx"
      via: "Sidebar component in left Panel"
      pattern: "Sidebar"
    - from: "src/main/App.tsx"
      to: "src/components/editor/ScriptEditor.tsx"
      via: "ScriptEditor component in center Panel"
      pattern: "ScriptEditor"
    - from: "src/components/preview/MarkdownPreview.tsx"
      to: "src/stores/scriptStore.ts"
      via: "useScriptStore for activeContent"
      pattern: "useScriptStore"
    - from: "src/main/App.tsx"
      to: "src/stores/scriptStore.ts"
      via: "initialize() call on mount"
      pattern: "initialize"
---

<objective>
Assemble the three-panel layout (sidebar + editor + preview), create the markdown preview and top bar, rewrite the main App.tsx, and polish the integration for a working end-to-end editor experience.

Purpose: This is the integration plan that brings all components together into a working application. The user should be able to open Steadi, create scripts, write markdown, see a preview, and find their work persisted on restart.
Output: A fully functional script editor with three-panel layout, markdown preview, top bar controls, and visual verification via checkpoint.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-script-editor/02-CONTEXT.md
@.planning/phases/02-script-editor/02-RESEARCH.md
@.planning/phases/02-script-editor/02-01-SUMMARY.md
@.planning/phases/02-script-editor/02-02-SUMMARY.md
@.planning/phases/02-script-editor/02-03-SUMMARY.md

@src/main/App.tsx
@src/main/main.tsx
@src/styles/globals.css
@src-tauri/tauri.conf.json
@src/components/ui/GlassPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MarkdownPreview, TopBar, and update globals.css</name>
  <files>
    src/components/preview/MarkdownPreview.tsx
    src/components/toolbar/TopBar.tsx
    src/styles/globals.css
  </files>
  <action>
    1. Create `src/components/preview/MarkdownPreview.tsx` with ABOUTME comment ("Rendered markdown preview panel for teleprompter scripts").
       - Reads `activeContent` from `useScriptStore`.
       - Renders a scrollable container with `react-markdown` and `remark-gfm` plugin.
       - Styling: full height, overflow-auto, padding 24-32px. Text white/80. Use Tailwind typography classes if available (`prose prose-invert prose-sm max-w-none`). If `prose` classes do not render correctly (Tailwind v4 may not bundle @tailwindcss/typography by default), fall back to manual markdown element styling via react-markdown's `components` prop to style h1-h3, p, strong, em, ul, ol, li, blockquote, code, a tags directly with Tailwind classes.
       - When content is empty, show subtle placeholder text: "Preview will appear here" in white/30.
       - Background: transparent or bg-white/3 to differentiate from editor.

    2. Create `src/components/toolbar/TopBar.tsx` with ABOUTME comment ("Top toolbar with sidebar/preview toggles and teleprompter launch controls").
       - Reads `sidebarVisible`, `previewVisible`, `toggleSidebar`, `togglePreview` from `useUIStore`.
       - Layout: horizontal bar at the top of the window, full width.
       - Left side:
         - Sidebar toggle button (hamburger/panel icon). Active state when sidebar is visible.
       - Right side:
         - Preview toggle button (labeled "Preview" or eye icon). Active state when preview is visible.
         - "Start Teleprompter" button (labeled with text, per CONTEXT.md). This button is a placeholder for Phase 3 -- it should exist but show a tooltip or do nothing yet ("Coming in a future update" or simply be disabled with a title attribute).
         - "Settings" button (labeled with text). Also a placeholder for future phases -- disabled or noop with title attribute.
       - Styling: bg-transparent or bg-white/3, border-bottom white/10, height ~40-48px, flex items-center justify-between, px-4. Buttons use white/60 text with hover to white/90, small rounded backgrounds on hover.
       - Make the top bar draggable as a window title bar by adding `data-tauri-drag-region` attribute to the bar container. This allows users to move the main window by dragging the top bar.

    3. Update `src/styles/globals.css`:
       - The existing `user-select: none` on `html, body` must remain (it is needed for the overlay window which shares this CSS). But add a specific override for the main window's editor area. Add a rule:
         ```css
         .cm-editor,
         .cm-editor * {
           user-select: text;
           -webkit-user-select: text;
         }
         ```
       - This ensures CodeMirror text selection works while keeping the rest of the UI non-selectable.
       - Do NOT remove any existing CSS rules. Only ADD the new rule.
       - If the `@tailwindcss/typography` plugin is needed for `prose` classes and is not automatically included by Tailwind v4, install it: `npm install @tailwindcss/typography` and add `@plugin "@tailwindcss/typography"` to the CSS file. Check if prose classes work first before installing.
  </action>
  <verify>
    - `npm run typecheck` passes
    - MarkdownPreview and TopBar export correctly
    - globals.css has the cm-editor user-select override
  </verify>
  <done>MarkdownPreview renders markdown content. TopBar provides sidebar/preview toggles and placeholder teleprompter/settings buttons. CSS override enables text selection in CodeMirror.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite main App.tsx with three-panel layout and update window config</name>
  <files>
    src/main/App.tsx
    src-tauri/tauri.conf.json
  </files>
  <action>
    1. Rewrite `src/main/App.tsx` (COMPLETELY replacing Phase 1 validation content -- it is no longer needed). Update the ABOUTME comment to reflect the new purpose ("Main application window with three-panel script editor layout").

       The new App component:
       - On mount, calls `useScriptStore.getState().initialize()` via useEffect to init the scripts directory and load state. Show a loading indicator (or nothing) while `isLoading` is true.
       - Layout (top to bottom):
         - TopBar at the top (outside the PanelGroup, fixed height)
         - PanelGroup (horizontal, fills remaining height) from `react-resizable-panels`
       - PanelGroup contains:
         - Sidebar panel (conditional on `sidebarVisible` from useUIStore):
           - `<Panel id="sidebar" defaultSize={25} minSize={15} maxSize={40} order={1} collapsible>`
           - `<PanelResizeHandle>` styled as a thin (1-2px) vertical line, white/10, hover to white/20 with transition
         - Editor panel:
           - `<Panel id="editor" order={2} minSize={30}>` (always present, expands to fill)
           - Contains `<ScriptEditor />`
         - Preview panel (conditional on `previewVisible` from useUIStore):
           - `<PanelResizeHandle>` (same style as sidebar handle)
           - `<Panel id="preview" defaultSize={50} minSize={20} order={3}>`
           - Contains `<MarkdownPreview />`
       - Use `autoSaveId="main-layout"` on the PanelGroup so panel sizes persist across sessions (built into react-resizable-panels).
       - Overall wrapper: `h-screen w-screen bg-neutral-900 flex flex-col overflow-hidden`.
       - The PanelGroup area should be `flex-1 overflow-hidden`.

    2. Update `src-tauri/tauri.conf.json`:
       - Change the main window dimensions to be appropriate for an editor app:
         - width: 1200 (was 600)
         - height: 800 (was 400)
       - Keep all other settings the same (label, title, center, resizable, decorations).

    3. Verify the complete integration:
       - Run `npm run check:all` to ensure everything compiles
       - Run `npm run tauri dev` briefly to confirm the app starts without runtime errors (check the terminal output, then close)
  </action>
  <verify>
    - `npm run check:all` passes (typecheck + lint + clippy + rust fmt)
    - `npm run build` succeeds (production build)
    - Main window config updated to 1200x800
    - App.tsx imports and uses Sidebar, ScriptEditor, MarkdownPreview, TopBar
    - PanelGroup has autoSaveId for layout persistence
    - initialize() is called on mount
  </verify>
  <done>Main App.tsx is a working three-panel editor layout. Sidebar, editor, and preview are wired together through Zustand stores. Window is sized for an editor app. Production build succeeds.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete script editor with:
    - Left sidebar with folders and scripts (create, rename, delete, drag-and-drop)
    - Center markdown editor with syntax highlighting and auto-save
    - Right toggleable markdown preview
    - Top bar with sidebar/preview toggle buttons
    - Local persistence (scripts survive app restart)
  </what-built>
  <how-to-verify>
    Run `npm run tauri dev` and test the following:

    1. **Create content:** Click the "+" button to create a new folder and script. Type some markdown (headers, bold, lists). Verify syntax highlighting appears.
    2. **Preview:** Toggle the preview panel on. Verify rendered markdown appears and updates as you type.
    3. **File tree:** Create multiple scripts and folders. Verify they appear in the sidebar with title and preview snippet.
    4. **Drag and drop:** Drag a script to reorder within a folder, and drag between folders.
    5. **Context menu:** Right-click a script or folder. Verify rename and delete work.
    6. **Sidebar toggle:** Toggle sidebar visibility. Verify editor expands to fill the space.
    7. **Persistence:** Close the app completely (Cmd+Q) and reopen. Verify scripts, folders, and content are preserved.
    8. **Resize:** Drag the dividers between panels. Verify they resize smoothly.
    9. **Visual:** Confirm overall dark aesthetic is consistent -- no bright/jarring panels, clean glassmorphic feel.
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 2, or describe any issues to fix.</resume-signal>
</task>

</tasks>

<verification>
- `npm run check:all` passes
- `npm run build` succeeds (production build)
- App launches via `npm run tauri dev` without errors
- Three-panel layout visible: sidebar, editor, preview
- Scripts persist across app restarts
- All Phase 2 requirements covered: EDIT-01 through EDIT-06, DSGN-03
</verification>

<success_criteria>
The Steadi main window is a functional notes-app-style script editor. Users can create folders and scripts, write markdown with syntax highlighting, preview rendered output, and find their work preserved on restart. The editor has a dark, polished aesthetic consistent with the Phase 1 overlay design. Top-right controls for teleprompter launch and settings are present as placeholders for Phase 3.
</success_criteria>

<output>
After completion, create `.planning/phases/02-script-editor/02-04-SUMMARY.md`
</output>
